\documentclass{classe-tex3R}
\usepackage{style-tex3R}

\begin{luacode}
  Format = 'fiche' --diapo/fiche
  Chapitre = "" --nom du chapitre
  Numero = '' --numéro du chapitre
  Niveau = '' --niveau de classe
\end{luacode}
\parametrage
%FIN PARAMÉTRAGE PRÉAMBULE



\newcommand{\regle}[4]{ % #1: position | #2: rotation | #3: début (cm) | #4: fin (cm)
\begin{scope}[shift={(#1)}, rotate=#2]
    % Calcul de la longueur réelle
    \pgfmathsetmacro{\longueur}{#4-#3}
    
    % Corps de la règle (plastique transparent)
    \draw[fill=gray!5, opacity=0.8] (0,-0.7) rectangle (\longueur, 0.7);
    
    % Graduation millimétrique
    \foreach \x in {0,0.1,...,\longueur} {
        \draw (\x, 0.7) -- (\x, 0.6);
    }
    
    % Graduation demi-centimètre
    \foreach \x in {0,0.5,...,\longueur} {
        \draw (\x, 0.7) -- (\x, 0.5);
    }
    
    % Graduation centimètre avec chiffres
    \foreach \x [evaluate=\x as \val using int(#3+\x)] in {0,1,...,\longueur} {
        \draw (\x, 0.7) -- (\x, 0.35);
        \node[font=\tiny, below] at (\x, 0.35) {\val};
    }
\end{scope}
}

\newcommand{\rapporteur}[2]{ % #1: centre (x,y) | #2: rotation
\begin{scope}[shift={(#1)}, rotate=#2]
    \def\Re{3.5}  % Rayon extérieur
    \def\Ri{2.2}  % Rayon intérieur
    \def\h{0.6}   % Hauteur de la barre de base

    % 1. Corps du rapporteur (Concentricité garantie par le centre 0,0)
    \filldraw[fill=green!10, draw=black, opacity=0.7, even odd rule] 
        % Forme extérieure
        (-\Re,0) -- (\Re,0) arc (0:180:\Re) -- cycle
        % Forme intérieure (évidement)
        % On part du point sur le cercle intérieur à la hauteur h
        ({-\Ri*cos(asin(\h/\Ri))},\h) -- ({\Ri*cos(asin(\h/\Ri))},\h) 
        arc ({asin(\h/\Ri)}:{180-asin(\h/\Ri)}:\Ri) -- cycle;

    % 2. Graduations millimétriques
    \foreach \a in {0,1,...,180} {
        \draw (\a:\Re) -- (\a:{\Re-0.15});
    }

    % 3. Double graduation (Noire et Rouge)
    \foreach \a in {0,10,...,180} {
        \draw (\a:\Re) -- (\a:{\Re-0.35});
        % Extérieur (Noir)
        \node[font=\tiny, black] at (\a:{\Re-0.6}) {\a};
        % Intérieur (Rouge)
        \pgfmathtruncatemacro{\inv}{180-\a}
        \node[font=\tiny, red] at (\a:{\Re-1.0}) {\inv};
    }

    % 4. Viseur central
    \draw[thick] (-0.2,0) -- (0.2,0);
    \draw[thick] (0,0) -- (0,0.2);
    \draw (0,0) circle (0.05);
\end{scope}
}



\newcommand{\compas}[4]{ % #1: position pointe | #2: écartement | #3: rotation | #4: miroir
\begin{scope}[shift={(#1)}, rotate=#3, xscale=#4]
    \def\L{5}          % Longueur branche grise
    \def\hP{0.6}       % Hauteur pointe/mine sous la branche
    \def\Ltot{\L+\hP}  % Longueur totale pour le calcul d'angle
    
    % Loi des sinus / Al-Kashi pour l'écartement exact au niveau des pointes
    % angle = 2 * arcsin( (ecart/2) / Ltotale )
    \pgfmathsetmacro{\ang}{2*asin(#2/(2*\Ltot))}
    
    % On place la charnière à la verticale de la pointe sèche (0, \Ltot)
    \begin{scope}[shift={(0, \Ltot)}]
        
        % Branche 1 : Porte-mine (mobile)
        \begin{scope}[rotate=-\ang]
            \draw[fill=gray!70] (-0.12,0) -- (0.12,0) -- (0.15,-\L) -- (-0.15,-\L) -- cycle;
            \draw[fill=gray!40] (-0.15,-\L) rectangle (0.15,-\L+0.5); % Attache mine
            \draw[fill=black!80] (-0.05,-\L) -- (0,-\L-\hP) -- (0.05,-\L) -- cycle; % La mine
        \end{scope}

        % Branche 2 : Pointe sèche (fixe verticalement)
        \begin{scope}[rotate=0]
            \draw[fill=gray!80] (-0.12,0) -- (0.12,0) -- (0.15,-\L) -- (-0.15,-\L) -- cycle;
            % La pointe métallique : son bout arrive exactement à (0,0) global
            \draw[fill=gray!30] (-0.03,-\L) -- (0,-\L-\hP) -- (0.03,-\L) -- cycle;
        \end{scope}

        % Tête et Poignée
        \begin{scope}[rotate=-\ang/2]
            \draw[fill=gray!90] (0,0) circle (0.25);
            \draw[fill=gray!90] (-0.08,0.25) rectangle (0.08,0.8);
            \draw[fill=gray!90] (0,0.8) ellipse (0.12 and 0.04);
        \end{scope}
    \end{scope}
\end{scope}
}


\newcommand{\equerre}[4] { % #1: pos | #2: rot | #3: longueur base | #4: longueur hauteur
\begin{scope}[shift={(#1)}, rotate=#2]
    \def\base{#3}
    \def\haut{#4}
    \def\ep{2.0} % Épaisseur du plastique sur les bords de l'angle droit

    % 1. Corps de l'équerre avec évidement parallèle
    \filldraw[fill=blue!15, draw=black, opacity=0.7, even odd rule] 
        (0,0) -- (\base+1.5,0) -- (0,\haut+1.5) -- cycle % Triangle Extérieur
        % Triangle Intérieur : on calcule le troisième sommet pour garder l'hypoténuse parallèle
        (\ep,\ep) -- ({\base+1.5-\ep*(1+(\base+1.5)/(\haut+1.5))},\ep) -- (\ep,{\haut+1.5-\ep*(1+(\haut+1.5)/(\base+1.5))}) -- cycle;

    % 2. Graduations Base (Horizontale)
    \foreach \x in {0,0.1,...,\base} {
        \draw (\x,0) -- (\x,0.15);
    }
    \foreach \x [evaluate=\x as \val using int(\x)] in {1,2,...,\base} {
        \draw (\x,0) -- (\x,0.3);
        \node[font=\tiny, above] at (\x,0.3) {\val};
    }

    % 3. Graduations Hauteur (Verticale)
    \foreach \y in {0,0.1,...,\haut} {
        \draw (0,\y) -- (0.15,\y);
    }
    \foreach \y [evaluate=\y as \val using int(\y)] in {1,2,...,\haut} {
        \draw (0,\y) -- (0.3,\y);
        \node[font=\tiny, right] at (0.3,\y) {\val};
    }

    % 4. Symbole de l'angle droit
    \draw (0.3,0) -- (0.3,0.3) -- (0,0.3);
\end{scope}
}



\begin{document}

\begin{luacode}
  Type = 'basique' --activite/bilan/corrige/cours/DM/DS/flash/interro/TD
  Compteur = '1' --Numérotation de l'entête
  Impression = false --true
  Header = false --true
  Taille = nil --'14pt'
  Stretch = false --true

  Correction = false --true
  Enonce = true --false
  Visible = true --false

  Competence = true --false
  Bareme = false --true
  Difficulte = false --true
  Source = false --true
  Theme = false --true
\end{luacode}
\parametrage
%FIN PARAMÉTRAGE DOCUMENT

\begin{tikzpicture}
    % Grille de repère pour vos tests
    \draw[help lines, gray!20] (0,0) grid (8,5);

    % Test de l'équerre au point (0,0)
    % \equerre{0,0}{0}{1}

    % Test de la règle au point (1,2) inclinée à 30°
    % \regle{1,2}{30}{0}{10}
    
    % Exemple : tracer une droite le long de la règle
    % \draw[red, thick] (1,2) -- ++(30:5);

    \rapporteur{0,1}{40} % Test du rapporteur au point (5,1) avec une rotation de -45°

   

    % L'arc de cercle tracé
    % \draw[blue, dashed] (3,0) arc (0:45:3);
    % Le compas posé sur l'arc (écartement 3, rotation 0)
    % \compas{0,0}{2.8}{0}{-1}

    % \equerre{0,0}{0}{12}{8}% Test de l'équerre  au point (0,0) avec une rotation de 0° et une échelle de 0.5
\end{tikzpicture}

\end{document}